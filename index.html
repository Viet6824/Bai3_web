<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Web IOT - Nguyễn Đức Việt</title>
<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background: #f0f4f7;
    color: #333;
}
header {
    background: #4facfe;
    background: linear-gradient(to right, #00f2fe, #4facfe);
    color: white;
    padding: 2rem;
    text-align: center;
}
main {
    max-width: 900px;
    margin: 2rem auto;
    padding: 2rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.login-form {
    display: flex;
    flex-direction: column;
    max-width: 400px;
    margin: 1rem auto;
}
.login-form input {
    padding: 0.75rem;
    margin-bottom: 1rem;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1rem;
}
.login-form button {
    padding: 0.75rem;
    background-color: #4facfe;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    transition: 0.3s;
}
.login-form button:hover {
    background-color: #00f2fe;
}
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 2rem;
}
th, td {
    padding: 0.75rem;
    text-align: center;
    border: 1px solid #ddd;
}
th {
    background-color: #4facfe;
    color: white;
}
@media (max-width:600px){
    .login-form, table {
        width: 100%;
    }
}
</style>
</head>
<body>

<header>
<h1>Chào mừng đến với web của Nguyễn Đức Việt</h1>
</header>

<main>
<section class="login">
<h2>Đăng nhập</h2>
<form class="login-form" id="loginForm">
    <input type="text" id="username" placeholder="Username" required>
    <input type="password" id="password" placeholder="Password" required>
    <button type="submit">Login</button>
</form>
<p id="loginMessage" style="color:red; text-align:center;"></p>
</section>

<section class="sensors">
<h2>Dữ liệu Sensors</h2>
<table id="sensorTable">
<thead>
<tr><th>Tên Sensor</th><th>Giá trị</th><th>Cập nhật lúc</th></tr>
</thead>
<tbody></tbody>
</table>
</section>
</main>

<script>
// Check session
let sessionId = localStorage.getItem("sessionId");

// Login form
document.getElementById("loginForm").addEventListener("submit", async function(e){
    e.preventDefault();
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;

    try{
        const res = await fetch("/login", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({username,password})
        });
        const data = await res.json();
        if(data.success){
            localStorage.setItem("sessionId", data.sessionId);
            document.getElementById("loginMessage").textContent = "Login thành công!";
            loadSensors();
        } else {
            document.getElementById("loginMessage").textContent = data.message;
        }
    }catch(err){
        console.error(err);
        document.getElementById("loginMessage").textContent = "Lỗi kết nối server!";
    }
});

// Load sensors from Node-RED API
async function loadSensors(){
    if(!localStorage.getItem("sessionId")) return;
    try{
        const res = await fetch("/sensors");
        const sensors = await res.json();
        const tbody = document.getElementById("sensorTable").querySelector("tbody");
        tbody.innerHTML = "";
        sensors.forEach(s => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${s.name}</td><td>${s.value}</td><td>${s.updated_at}</td>`;
            tbody.appendChild(tr);
        });
    }catch(err){
        console.error(err);
    }
}

// Auto-refresh sensors every 5s
if(sessionId) loadSensors();
setInterval(loadSensors, 5000);
</script>

</body>
</html>
